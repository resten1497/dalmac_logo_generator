<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>A4 Canvas 출력</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fabric@5.3.0/dist/fabric.min.js"></script>
  </head>
  <body>
    <input type="file" id="excelFile" />
    <button id="printBtn" style="display: none">A4로 출력</button>

    <script>
      document
        .getElementById("excelFile")
        .addEventListener("change", async function (e) {
          const file = e.target.files[0];
          const reader = new FileReader();

          reader.onload = async function (evt) {
            const data = new Uint8Array(evt.target.result);
            const workbook = XLSX.read(data, { type: "array" });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const json = XLSX.utils.sheet_to_json(worksheet);

            await generateMergedA4Image(json);
          };

          reader.readAsArrayBuffer(file);
        });

      async function generateMergedA4Image(dataArray) {
        const cellWidth = 786; // 약 794 / 3 - padding 고려
        const cellHeight = 500;
        const rows = 3;
        const cols = Math.ceil(dataArray.length / rows);

        const canvasWidth = 2480; // A4 width (px @ 96dpi)
        const canvasHeight = 3508;

        const mergedCanvas = document.createElement("canvas");
        mergedCanvas.style.imageRendering = "crisp-edges";
        mergedCanvas.width = canvasWidth;
        mergedCanvas.height = canvasHeight;
        const ctx = mergedCanvas.getContext("2d");

        const imagePromises = dataArray.map((row) => createImageAsDataUrl(row));
        const images = await Promise.all(imagePromises);

        images.forEach((dataURL, i) => {
          const img = new Image();

          img.src = dataURL;
          const col = Math.floor(i / rows);
          const row = i % rows;

          img.onload = () => {
            ctx.drawImage(
              img,
              row * cellWidth,
              col * cellHeight,
              cellWidth,
              cellHeight
            );
          };
        });

        // 출력 버튼 활성화
        document.getElementById("printBtn").style.display = "inline-block";
        document.getElementById("printBtn").onclick = () => {
          setTimeout(() => {
            const dataUrl = mergedCanvas.toDataURL("image/png");
            const printWindow = window.open("", "_blank");
            if (!printWindow) {
              alert("팝업 차단이 되어 있거나 새 창을 열 수 없습니다.");
              return;
            }

            // 문서 구조 직접 구성
            const doc = printWindow.document;
            doc.open();

            // 1. 기본 구조 생성
            const html = doc.createElement("html");
            const head = doc.createElement("head");
            const body = doc.createElement("body");

            // 2. 스타일 추가
            const style = doc.createElement("style");
            style.textContent = `
        body { margin: 0; padding: 0; text-align: center; }
        img { width: 100%; height: auto; }
      `;
            head.appendChild(style);

            // 3. 이미지 요소 추가
            const img = doc.createElement("img");
            img.src = dataUrl;
            img.onload = function () {
              printWindow.focus();
              printWindow.print();
              printWindow.close();
            };
            body.appendChild(img);

            // 4. 전체 문서 구성
            html.appendChild(head);
            html.appendChild(body);
            doc.appendChild(html);
            doc.close();
          }, 500);
        };
      }

      function createImageAsDataUrl(row) {
        return new Promise((resolve) => {
          // 배경 추가
          const canvas = new fabric.Canvas(null, {
            width: 786,
            height: 500,

            backgroundColor: "white",
            objectCaching: false,
          });
          // 상수 정의
          const COLORS = {
            background: "#BF1A20",
            textWhite: "white",
            textHighlight: "#C32534",
            alcBackground: "yellow",
            alcBorder: "#F2C235",
          };
          const FONTS = {
            title: "Gmarket",
            subtitle: "Acumin",
          };
          const DIMENSIONS = {
            canvasHeight: 380,
            alcWidth: 242 * 0.6,
            alcHeight: 42 * 0.7,
          };

          let items = {
            type: 1,
            title: "조조조조조조조조조조조",
            sub_title: "CCCCCCCCCCCCCCCCCCCCCCCCCCC",
            ibu: 3,
            country: "Belgium",
            discount: 3,
            alc: "4.0%",
            style: "Pastry Imperial Stout",
            character: "블랙베리 / Blackberry",
            price: "7,500 원",
          };

          // 배경 추가
          const Background = new fabric.Rect({
            width: canvas.width,
            height: DIMENSIONS.canvasHeight,
            fill: COLORS.background,
            selectable: false,
            objectCaching: false,
          });

          const border = new fabric.Rect({
            left: 0,
            top: 0,
            width: canvas.width - 4,
            height: canvas.height - 4,
            fill: "",
            stroke: "#DDDDDD",
            strokeWidth: 4,
            selectable: false,
            evented: false,
            strokeUniform: true,
          });

          canvas.add(Background);
          canvas.add(border);
          canvas.renderAll();
          setTimeout(() => {
            const dataURL = canvas.toDataURL({
              format: "jpeg",
              quality: 1.0,
              multiplier: 4,
            });
            resolve(dataURL);
          }, 500);
        });
      }
    </script>
  </body>
</html>
